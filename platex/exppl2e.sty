% \iffalse meta-comment
%
% This is file `exppl2e.sty', for experimental pLaTeX2e.
%
% Copyright (c) 2010 ASCII MEDIA WORKS
% Copyright (c) 2016 Japanese TeX Development Community
%
% This file is part of the pLaTeX2e system (community edition).
% -------------------------------------------------------------
%
% ======================================================================
%   開発者およびテスト協力者の方へ (2016-06-25 aminophen)
%
% コードの不用意な改変は即エンバグにつながり、利用者の多い (u)pLaTeX では
% 特に影響が大きいという思われます。その一方で、unstable なものもなるべく
% 手軽にテストして頂きたいとも考えます。
% この exppl2e.sty は、カーネル (stable) に将来含めることを想定した実験的
% コードを配布することを目的に作成しました。開発の便宜のため、dtx ファイル
% 互換ドキュメントもパッケージコードと同じく含められるようにしてあります。
%   \RequirePackage{exppl2e}
%   \documentclass{article}
% のようにして、テストをよろしくお願いします。一方で
%   platex exppl2e.sty
% を実行すると、dtx ドキュメントと同様に処理することができます。
% ========================================================================
%
%%%%%%%% ^^A driver-like trick using catcode difference
%
% This file `exppl2e.sty' is a normal LaTeX package, so
%   \RequirePackage{exppl2e}
% and
%   \usepackage{exppl2e}
% works. However, it can also be typeset alone:
%   platex exppl2e.sty
% for convenience.
%
\ifx\undefined\@undefined\relax
% case 1: This file must be a normal package
  \NeedsTeXFormat{pLaTeX2e}
  \ProvidesPackage{exppl2e}
                [2016/06/25 v1.0 Experimental pLaTeX2e features]
  \PackageWarningNoLine{exppl2e}{%
      This is the unstable, experimental part of pLaTeX2e.\MessageBreak
      This package may contain:\MessageBreak
       * future patches to pLaTeX\MessageBreak
       * experimental new features\MessageBreak
      Please note that these can be removed without any\MessageBreak
      announcement at some point in the future, and may\MessageBreak
      also have some critical bugs. We appreciate any\MessageBreak
      reports and comments. Thank you for your cooperation}
  \RequirePackage[latest]{platexrelease}
\else
% case 2: This file pretends to be a document
  \documentclass{jltxdoc}
  \title{Experimental p\LaTeXe}
  \author{Japanese \TeX\ Development Community}
  \begin{document}
    \newcommand\Lpack[1]{\textsf{#1}}
    \maketitle
    \DocInput{exppl2e.sty}
  \end{document}
\fi % ^^A   In case 2, this \fi comes after \end{document}
%     ^^A   so it has no effect.
% \fi ^^A   This \fi corresponds to \iffalse, and another
%     ^^A   \fi is required for \ifx, see below;)
%
%%%%%%%% ^^A trick end
%
% \fi
%
%
% ここからp\LaTeXe{}のexperimentalコード本体です。
%
%
% \section{出力ルーチン}
%
% \begin{macro}{\AtBeginDvi}
% p\LaTeX{}の出力ルーチンの|\@outputpage|では、|\shipout|するvboxの中身に
% |\yoko|を指定しています。このため、|\AtBeginDocument{\AtBeginDvi{}}|という
% コードを書くと\texttt{Incompatible direction list can't be unboxed.}という
% エラーが出てしまいます。
%
% そこで、コミュニティ版p\LaTeX{}では「|\shipout|で|\yoko|が指定されている」
% ことを根拠として
% \begin{center}
% |\@begindvibox|は（空でない限り）常に横組でなければならない
% \end{center}
% と仮定します。この仮定に従い、|\AtBeginDvi|を再定義します。
% \changes{v???}{????/??/??}{\cs{@begindvibox}を常に横組に}
%    \begin{macrocode}
%<platexrelease>\plIncludeInRelease{????/??/??}{\AtBeginDvi}
%<platexrelease>                   {Fix for incompatible direction}%
%<*plcore|platexrelease>
\def\AtBeginDvi#1{%
  \global \setbox \@begindvibox
    \vbox{\yoko \unvbox \@begindvibox #1}%
}
%</plcore|platexrelease>
%<platexrelease>\plEndIncludeInRelease
%<platexrelease>\plIncludeInRelease{0000/00/00}{\AtBeginDvi}
%<platexrelease>                   {Fix for incompatible direction}%
%<platexrelease>\def \AtBeginDvi #1{%
%<platexrelease>  \global \setbox \@begindvibox
%<platexrelease>    \vbox{\unvbox \@begindvibox #1}%
%<platexrelease>}
%<platexrelease>\plEndIncludeInRelease
%    \end{macrocode}
% \end{macro}
%
% \section{PDFのブックマークとアクセント文字}
%
% 
% \begin{macro}{\pltx@isletter}
%    \begin{macrocode}
%<platexrelease>\plIncludeInRelease{????/??/??}{\pltx@isletter}
%<platexrelease>                   {Support PD1 encoding}%
%<*pldefs|platexrelease>
\def\pltx@pdfencA{PD1}
\def\pltx@composite@chkenc{%
  \ifx\pltx@pdfencA\f@encoding
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}
\long\def\pltx@isletter@iv#1#2#3\pltx@mark{%
  \pltx@cond\ifx\pltx@mark#3\pltx@mark\fi{%
    \pltx@cond{\ifnum0\ifcat A\noexpand#21\fi\ifcat=\noexpand#21\fi>\z@}\fi
      {\@firstoftwo}{\pltx@composite@chkenc}%
  }{\pltx@composite@chkenc}}
%</pldefs|platexrelease>
%<platexrelease>\plEndIncludeInRelease
%<platexrelease>\plIncludeInRelease{2016/06/19}{\pltx@isletter}
%<platexrelease>                   {Support PD1 encoding}%
%<platexrelease> \long\def\pltx@isletter@iv#1#2#3\pltx@mark{%
%<platexrelease>  \pltx@cond\ifx\pltx@mark#3\pltx@mark\fi{%
%<platexrelease>    \pltx@cond{\ifnum0\ifcat A\noexpand#21\fi\ifcat=\noexpand#21\fi>\z@}\fi
%<platexrelease>      {\@firstoftwo}{\@secondoftwo}%
%<platexrelease>  }{\@secondoftwo}}
%<platexrelease>\plEndIncludeInRelease
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@text@composite@x}
%    \begin{macrocode}
%<platexrelease>\plIncludeInRelease{????/??/??}{\@text@composite@x}
%<platexrelease>                   {Fix for non-zero baselineshift}%
%<*pldefs|platexrelease>
\def\@text@composite@x#1#2{%
  \ifx#1\relax
    #2%
  \else\pltx@isletter{#1}{#1}{%
    \begingroup
    \setbox\z@\hbox\bgroup%
      \ybaselineshift\z@\tbaselineshift\z@
      #1%
      \g@tlastchart@\@tempcntb
      \xdef\pltx@composite@temp{\noexpand\@tempcntb=\the\@tempcntb\relax}%
      \aftergroup\pltx@composite@temp
    \egroup
%    \end{macrocode}
%    \begin{macrocode}
    \ifnum\@tempcntb<\z@
      \@tempdima=\iftdir
          \ifmdir
            \ifmmode\tbaselineshift\else\ybaselineshift\fi
          \else
            \tbaselineshift
          \fi
        \else
          \ybaselineshift
        \fi
      \@tempcntb=\@cclvi
    \else\@tempdima=\z@
    \fi
%    \end{macrocode}
% アクセントが付く「本体の文字」が欧文文字と推測される場合には、
% 一旦数式モードに入ることによって\cs{xkanjiskip}が前後に入るようにします。
% 必要なら、数式モードの前後に\cs{null}を補って\cs{xkanjiskip}の挿入を抑制します。
%    \begin{macrocode}
    \ifnum\@tempcntb<\@cclvi
      \ifnum\@tempcntb>\m@ne\ifnum\@tempcntb<\@cclvi
        \ifodd\xspcode\@tempcntb\else\leavevmode\hbox{}\fi
      \fi\fi
      \begingroup\mathsurround\z@$%
        \ifx\textbaselineshiftfactor\@undefined\else
          \textbaselineshiftfactor\z@\fi
        \box\z@
      $\endgroup%
      \ifnum\@tempcntb>\m@ne\ifnum\@tempcntb<\@cclvi
        \ifnum\xspcode\@tempcntb<2\hbox{}\fi
      \fi\fi
%    \end{macrocode}
%    \begin{macrocode}
    \else
      \ifdim\@tempdima=\z@{\ybaselineshift\z@\tbaselineshift\z@#1}%
      \else\lower\@tempdima\box\z@\fi
    \fi
    \endgroup}%
  \fi
}
%</pldefs|platexrelease>
%<platexrelease>\plEndIncludeInRelease
%    \end{macrocode}
% \end{macro}
%
\endinput
